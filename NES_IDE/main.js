/*
catch errors coming from opening a project that does not exist
*/

// 'use strict'

const assemblerSource = './nesasm-master/source/';
const assemblerPath = './nesasm-master/nesasm';
const emulatorPath = 'fceux'; //installed program name

const fs = require('fs');

const express = require('express');
const bodyParser = require('body-parser');
const app = express();

var checkedOutProjectName = null;
var savedata = null;
initServer();

// app.use(bodyParser.urlencoded({ extended: false }));
// app.use(bodyParser.json());
app.use(express.static('public'));
app.use(bodyParser.json({limit: '10mb'}));
app.use(bodyParser.urlencoded({limit: '10mb', extended: true}));

app.get('/', async (req, res) => {
    
});
app.post('/', async (req, res) => {
    console.log("webpage load");
    checkedOutProjectName = null;
    savedata = null;
    res.send({projectstatus: "clear"});
});
app.post('/newproject', async (req, res) => {
    var callsRemaining = 6;
    var returnData = {};

    var requestProjectName = req.body.name;
    checkedOutProjectName = requestProjectName;

    //MUST wait for this to finish creating all files
    newProject(requestProjectName, function(clientMessage){
        transcribePalServerToClient(function(response){
            returnData["backgroundPalette"] = response.background;
            returnData["spritePalette"] = response.sprite;
            callsRemaining -= 1;
            if (callsRemaining <= 0){
                res.send(returnData);
            }
        });
        transcribeTxtServerToClient(function(response){
            returnData["code"] = response.code;
            callsRemaining -= 1;
            if (callsRemaining <= 0){
                res.send(returnData);
            }
        });
        transcribeSprServerToClient(function(response){
            returnData["sprites"] = response.sprites;
            callsRemaining -= 1;
            if (callsRemaining <= 0){
                res.send(returnData);
            }
        });
        transcribeBkgServerToClient(function(response){
            returnData["backgrounds"] = response.backgrounds;
            callsRemaining -= 1;
            if (callsRemaining <= 0){
                res.send(returnData);
            }
        })
        transcribeSprPalPairsServerToClient(function(response){
            returnData["sprPalPairs"] = response.sprPalPairs;
            callsRemaining -= 1;
            if (callsRemaining <= 0){
                res.send(returnData);
            }
        });
        transcribeBkgPalPairsServerToClient(function(response){
            returnData["bkgPalPairs"] = response.bkgPalPairs;
            callsRemaining -= 1;
            if (callsRemaining <= 0){
                res.send(returnData);
            }
        });
    });
});
app.post('/closeproject', async (req, res) => {
    checkedOutProjectName = null;
});
app.post('/openproject', async (req, res) => {
    var callsRemaining = 6;
    var returnData = {};

    var requestProjectName = req.body.name;
    checkedOutProjectName = requestProjectName;
    
    transcribePalServerToClient(function(response){
        returnData["backgroundPalette"] = response.background;
        returnData["spritePalette"] = response.sprite;
        callsRemaining -= 1;
        if (callsRemaining <= 0){
            res.send(returnData);
        }
    });
    transcribeTxtServerToClient(function(response){
        returnData["code"] = response.code;
        callsRemaining -= 1;
        if (callsRemaining <= 0){
            res.send(returnData);
        }
    });
    transcribeSprServerToClient(function(response){
        returnData["sprites"] = response.sprites;
        callsRemaining -= 1;
        if (callsRemaining <= 0){
            res.send(returnData);
        }
    });
    transcribeBkgServerToClient(function(response){
        returnData["backgrounds"] = response.backgrounds;
        callsRemaining -= 1;
        if (callsRemaining <= 0){
            res.send(returnData);
        }
    });
    transcribeSprPalPairsServerToClient(function(response){
        returnData["sprPalPairs"] = response.sprPalPairs;
        callsRemaining -= 1;
        if (callsRemaining <= 0){
            res.send(returnData);
        }
    });
    transcribeBkgPalPairsServerToClient(function(response){
        returnData["bkgPalPairs"] = response.bkgPalPairs;
        callsRemaining -= 1;
        if (callsRemaining <= 0){
            res.send(returnData);
        }
    });
});
app.post('/saveproject', async (req, res) => {
    if (checkedOutProjectName === null){
        res.send({savedataresponse: "A project must be opened first"});
    }
    else{
        if (req.body.savedata !== undefined && req.body.confirmation === undefined){
            savedata = req.body.savedata;
            res.send({savedataresponse: savedata});
        }
        if (req.body.savedata === undefined && req.body.confirmation !== undefined){
            if (req.body.confirmation === 'good'){
                //attempt to write data to save
                console.log("Saving data since confirmed good");
    
                var callsRemaining = 6;
                var returnData = {confirmationresponse: "saved"};
    
                transcribePalClientToServer(function(response){
                    callsRemaining -= 1;
                    if (callsRemaining <= 0){
                        res.send(returnData);
                    }
                });
                transcribeTxtClientToServer(function(response){
                    callsRemaining -= 1;
                    if (callsRemaining <= 0){
                        res.send(returnData);
                    }
                });
                transcribeSprClientToServer(function(response){
                    callsRemaining -= 1;
                    if (callsRemaining <= 0){
                        res.send(returnData);
                    }
                });
                transcribeBkgClientToServer(function(response){
                    callsRemaining -= 1;
                    if (callsRemaining <= 0){
                        res.send(returnData);
                    }
                });
                transcribeSprPalPairsClientToServer(function(response){
                    callsRemaining -= 1;
                    if (callsRemaining <= 0){
                        res.send(returnData);
                    }
                });
                transcribeBkgPalPairsClientToServer(function(response){
                    callsRemaining -= 1;
                    if (callsRemaining <= 0){
                        res.send(returnData);
                    }
                });
    
                //catch error
                // res.send({confirmationresponse: "unsaved"});
            }
            else if (req.body.confirmation === 'bad') {
                console.log("Not saving data since not confirmed good");
                res.send({confirmationresponse: "unsaved"});
            }
        }
    }
});
app.post('/runproject', async (req, res) => {
    if (checkedOutProjectName === null){
        res.send({response: "A project must be opened first"});
    }
    else
    {
        const {exec} = require('child_process');
        // var assembleCommand = './nesasm-master/nesasm ./projects/' + checkedOutProjectName + '/code.s';
        var assembleCommand = assemblerPath + ' ./projects/' + checkedOutProjectName + '/code.s';
        // var emulatorCommand = 'fceux ./projects/' + checkedOutProjectName + '/code.nes';
        var emulatorCommand = emulatorPath + ' ./projects/' + checkedOutProjectName + '/code.nes';
        exec(assembleCommand, (err, stdout, stderr) => {
            console.log(err);
            console.log(stdout);
            console.log(stderr);
            exec(emulatorCommand, (err, stdout, stderr) => {

            });
        });

        res.send({response: "good"});
    }
});

app.use((req, res) => {
    res.status(404).send(`<h2>Uh Oh!</h2><p>Sorry ${req.url} cannot be found here</p>`);
});
app.listen(11111, () => console.log('The server is up and running on port 11111...'));




///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////SERVER FUNCTIONS///////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////

function initServer(){
    const {exec} = require('child_process');
    // exec('make clean -C ./nesasm-master/source/', (err, stdout, stderr) => {
    //     console.log("cleaned nesasm-master");
    //     exec('make -C ./nesasm-master/source/', (err, stdout, stderr) => {
    //         console.log("made nesasm-master");
    //     });
    // });
    var makeCommand = 'make -C ' + assemblerSource;
    exec(makeCommand, (err, stdout, stderr) => {
        console.log("made nesasm-master");
    });

    fs.mkdir('./projects/', 0777, function(err){
        if (err){
            handleInitServerException(err);
        }
    });
}

function newProject(projectDir, cb){
    var clientMessage = {condition: true, message: "New Project Created Successfully"};
    fs.mkdir('./projects/' + projectDir, 0777, function(err){
        if (err){
            handleNewProjectDirectoryException(err, projectDir, null, clientMessage);
            cb(clientMessage);
        } else{
            var filesRemaining = 6;
            //write file overwrites files by default
            fs.writeFile('./projects/' + projectDir + '/code.s', 'enter code here', function(err){
                if (err){
                    handleNewProjectFileException(err, projectDir, 'code.s', clientMessage);
                } else {
                    console.log("created code file for project: " + projectDir);

                    //START
                    const {exec} = require('child_process');
                    var cpCommand = 'cp ./projects/defaultcodefile.txt ' + './projects/' + checkedOutProjectName + '/code.s';
                    exec(cpCommand, (err, stdout, stderr) => {
                        console.log(err);
                        console.log(stdout);
                        console.log(stderr);

                        var wcCommand = 'wc -c < ./projects/' + checkedOutProjectName + '/code.s';
                        var waitInterval = setInterval(function(){
                            exec(wcCommand, (err, stdout, stderr) => {
                                console.log(stdout);
                                if (parseInt(stdout) > 17){
                                    clearInterval(waitInterval);
                                    filesRemaining -= 1;
                                    if (filesRemaining === 0){
                                        cb(clientMessage);
                                    }
                                }
                            });
                        }, 500);
                    });
                }
            });
            var defaultPalette = Buffer.from(`0001020300111213002122230031323300010203001112130021222300313233`, "hex"); //left half for background right half for sprite
            // var defaultPalette = Buffer.from('0001010100010101000101010001010100010203001112130021222300313233', 'hex'); //left half for background right half for sprite            
            fs.writeFile('./projects/' + projectDir + '/palette.pal', defaultPalette, function(err){
                if (err){
                    handleNewProjectFileException(err, projectDir, 'palette.pal', clientMessage);
                } else {
                    console.log("created palette file for project: " + projectDir);
                }
                filesRemaining -= 1;
                if (filesRemaining === 0){
                    cb(clientMessage);
                }
            });
            var defaultSprites = Buffer.from('a0000000000000006000000000000000ff00ff000000000000ffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff0000000000000000', 'hex');
            // var defaultSprites = Buffer.from('030f1f1f1c242666000000001f3f3f7fe0c080fc80c0002000206000f0fcfefe607018070f1f3f7f7f7f1f07001e3f7ffc7c0000e0f0f8f8fcfcf8c0c2672f377f7fffff07070f0f7f7efcf0f8f8f070fdfeb4f8f8f9fbff37365c000001031f1f3ffffffc7070380824e3f0f8707038ffffff1f000000001f1f1f1f00000000000001070f0f0e120000000000000f1f0000f0e0c0fe4060000000103000f8fe13333018040f1f1f1f3f3f1f0708171700107e3e0000c0e0fffffefefce040a03f3f3f1f1f1f1f1f3727230301000000f0f0f0f8f8f8f8f8ccffffffff700008fffffffef0c08000f0f0f0f0f0c08000fcfcf87878787e7e1060800078787e7e00030f1f1f1c242600000000001f3f3f00e0c080fc80c0000000206000f0fcfe666030180f1f3f3f7f7f3f1f00162f2f20fc7c0000e0e0f0fefcfcf8c06020303f3f3f3f3f3f3f1f2f2f2f0f07030000f09000080c1cfcf810f0f0f0f0e0c0e00f0f0707070f0f0301030104070f0f03f8f0e0f0b080e0e0f8f0e070b080e0e0033f7f190909285c0030707ffffff7f3f8e0e0fc2630801000181000f8f8feff3e1e3f383030003ae70f0f1f1f1f0f07781e80fe7e7e7f7ffffefcc68eeeffff3c3f1f0f073f21200300000e073f3f3ffffffffefefefc70ff7f3f0ec0c0e0e00f9fcfff7f3f1e0e0080c8fe7f3f1e0e20c0808000000000e0000000000000000000030f1f1f1c240000000000001f3f0004e6e0ffff8f830e1f1f1f1f03ffff26266078180f7fff3f3f7f7f1f007eff0121fe7a06fefcfcfffffefefede5c6cffcf8707070f1f1ffffffefcf8b06000f8f8f0b8f8f9fbff283018400001030f1ffffffffffec08010ece3e0e0e0c080ffffff3f000000000f0f0f0f0000000013333018040f1f1f1f3f3f1f0709131700107e30e0f0f0e0fffffefffefcf8e01f1f0f0f0f1f1f1f1717030000000000f0f0f8f8b8f8f8f8d0901808400000003ffffffff6c6840030f0f0f1f6c68400f0e080000000000000000000000000001f1f3f3f1f0f0f1f1f1f3f3e7c78f0e0f0f0f8f8b8f8f8f0b090180840000000e0f0f0f0f0f0f8f0c0e0fcfeff7f03001f1f1f3f3e3c3818000010383e3c3818000307070a0b0c00000000070f0f0f0300e0fc2020103c00000000f0fcfefcf80707071f1f3e2101070f1b1810302101e0e0e0f0f0e0c0e0a8fcf8000000c0e0070f0e141618003f00000f1f1f1f073cc0f84040207800c00000e0f8fcf8f0c03f0e0f1f3f7c7038fcedc00000607038f0f8e4fcfc7c00007e1e040c0c0c0000070f0e141618000f00000f1f1f1f070d1f1f1f1c0c0707071e1c1e0f07000707e060f070e0e0f0806090008000e0f080071f3f1213081f3100103f7f7f3f030fc0f040003018c0f80000e0f8fcf8b03831391f1f0f5f7e3c1f07000e0f537c3cf8f8f0e0e0c00000f8f8f0000080000000e0fc2727113e04070703f7fffffefc3f7f3f0f1f3f7f4f3e7fffe250387040f8f9f9b7ffffe000e871014b0303000007070f3f3f3f26040503013030302604f0f0f0e0c0000000fefce0000000000007070f1f3f0f1c1805030110300c1c18e0e0e0e0c0800000c0e0f07818080000070f1f0f3f0f1c18070f3e7c300c1c18e0e0e040c080000060606080000000007ffffffb0f0f0f1f73f3f0f4f0f070603f7e7c7c3c3cfcfc000000003c3cfcfc607018080f1f3f7f7f7f1f070b1b3b7bfc7c0020f0f8fcfefcfcf8e0d0d8dcde0b0f1f1e3c3c3c7cc4e0e040003c3c7c1f3f0d070f0e1c3c1d3c3a3830001c3c0000000000000000225555555555772200071fff071f0f0600000000000000003ffffffffffffb760000cf077f00000020f8ffc3fdfef04000003cfcfee0000040e0404041414f4740e0403f3e3e3038000000000000e0c0000000f8f8f8183843464440404040403c393b3f0000000080c04000000000007838b8f8000000003130387c7ffffffb3f3f0f7777f7f7f7107e3e001efefffffffefefefafaf3e7ffffe3c387483cfcf0f8fc7c78383cfc00ffc38383ffffffff00c38181c3ff001f1f0f07010000000000000000000000f0fbfffffe3e0c04000b1f1f1e3e0c041f1f0f0f070000000000000000000000fbffffffff000000030f0f0f0f00000000183c7e6edfdfdf00183c7e76fbfbfb0018183c3c3c3c1c001010202020202000080808080808000008080808080808000808040404040400101038383838383c7e77fb9f5f8e2000183c0e0e0400005c2e8f3f7b777e3c000004061e3c1800134f3fbf3f7af8f80000010a170f2f1f0008050f2f1d1c3c0000000005070f0700000000020b070f000000000000010300000000000804040060f0f87c3e7e7f02020205717f7f7f3f5f7f3e0e0a512000000000000000040000000000000e1f02020001133f7f7f3f7f7ffeecca51200040607073270f1f004063777c38f8e40000000003070f1f000003070c18f8e47f7f3f3f1f1f0f07034428100804030403070f1f3f7777f503070f1f277b78fbc0e0f0f8fceeeeafc0e0f0f8e4de1edff1ff780000181c0effff7f0f0f0703008fff1e000c3e7e7cfffffef0f0c0800000000000000000000000182424180000000241416133063c3c7effffffff7e3c03070f1f3f7f7fff03070f1f3f6341c1c0e0f0f8fcfefeffc08000008cfefef3ffffff7800000000c1e3ff470f0f0f07ffffff1e00202040f1f9ffe2f0f0f0e0161f3f7f3d1d3f1f161f0000050d3f1f8080c0e0f0f0f0f88080000000a0a0e03cfab172f2dbdf5f00044e8c0c7fffff000000010101061e00000000000001010000000000000000ff7f3f1f0f070301007cd692baeefe38ff83296d451101c700153f625fff9f7d0808021f22020200000000000000000008080808080808082f1e2f2f2f150d0e101e1050100800000000000000000000000000fe000000001c3e7ffffffe7c381c2a77eeddaa742800fffffffffffffffffefe00efefef00fffffffffffffffffefefe00efefef007fffffffffffffff007f5f7f7f7f7f7f684ee0e0e0f0f8fcb89e80c0e0f0f87c3f5c393bbbf9fcfe0023574f5727c321c0f0f0f0f0e0c00000307070f0e0c000fefc610ffffef0e0130f1ef0fcf8f0e06e40e0e0e0e0e0c0be9080c0c080000001010303077f7f3f01010303077f7d3d06073f3c197b7f3f06043023066460003f7f7f1f3f3f0706006060002030040603070f0f0f0f07030001010000000000f8f8f8a0e1fffffffeffff40010303030f0f0f1f1f1f0f070101000000000000e0f8f8f8fffef0c0e0feff7f03020000010f0f1f3933377f010d0800362c08607f3f3f3f1f0f0f016000203000080d0100000303476777770101034367777b78000000008898f8f000008084ccdcbc3c7e7fff1f07301c0c330707e3383f1c0c7e38f6eddf38706098c7c89230f870600000000303476777000101034367777b00000000008898f80000008084ccdcbc777e7fff1f0770f078330707e3387ff0f07e38f6eddf383c3c98c7c89230f83c03070a1a1c1e0b0800107f7f7f1f0f0f1c3f3f3d3f1f00000333393a381800000000044c4e4e466f10383c7476767e7d001f3f3f4f5f7f7f0000110a342a51207f67a3b0d8dedcc87f676370383e7cb87f7f7f1f47707039510a04ea797f7039e8e8e0c01070e0c058381030f0f0e0c0000000206666666200081c3c7a7a7a7e00001f3f7f4f5f7f000000110a342a51777f3fb7b3dbdad87f7d3f37333b3a787f7f7f7f1f0770f020510a04ea397ff0cce8e8e0c0187c3ebc58381030f8fc3e030f1f3f3b3f7f7f000000060e0c000080f0f8fcfefefffe0000000000000f187f7f7f7fff0f030000000000f83e3b18fefbfffff6e0c000101410103878f83000030f1f3f3b3f7f00000000060e0c0000c0f0f8fcfefeff000000000000000f7f7f7f7f7fff0f030000000000f87ef3fefefbfffff6e0c01810141010387cde0001010101000008000d1e1e1e1f0f0778f0f8e4c0cacac078f0001a3f35353f0f1f9fffff7f7420000080e0e0707321e4fffefc9c1e00001a070c1878fefcf0000103030703010000010200387c7e3f005f7f7f3f3f14003f40606020301301c0e0f030383c3cfcc0e030d0d0d0d000070f1f222025251f070f021d1f1a1a02fefe7e3a02014141387cfcfcfcfebebe1f3f7e5c408082821c3e3f3f3f7f7d7d8280a0444340211e7d7f5f3b3c3f1e001c3f3e3c408082821c3e3f1f3f7f7d7d00008080929dc7ef0000006062653f1f0023333f3f7f7f7f703c3c1800000207fef8a00000008080cf7a5a100000c0807e7f7d3f1e8f8f19858486c6e77373e1e00e73f3f9f9f870804e77f3fbf9fa780e66e2f6ffff1f9811397d390000e0e7000000040f0f1f070000070716100038f3e7eeeccdcfcfdfcf1f171033303020273f3f783c1f1f73383040c70766e06c9f3e7cfcf8f8c04060c080049efff0f87f7e7801071f3c7c240107feff7f3f7ffcf8a0fefcf08000cf7a0afefc0000007e7f7f3f1f8f8f18858683c3e17070e09f3e7cf8f83c18f860c0800098fcfeff7f7f78010713f103240007feff7fff0300001c1d1bc3e3e1030f2362643c1c1ee0cd1d4feeff3f3f1f3d6d4feef320033f3f000070b8fcfc07071f3f0f470300070f1f3f3e7c7878000003070f0f1f1f3f5c393bbffffefe0023574f572fdf21c0c08080808000000000000080800000fefc610f7f3f1f1e230f1ef01c3f1f1ef078e4c8ccbebe3e0080183034fefefe000100070707071f000001040606070700000f3f3f0f00000f3f7ff8f87f3f0f787c7e7f3f3f1b091f1f1f0b010100000c000000077f7c00031f3f3f780003ff01e171793d3d1f0300000000000000003f3f1f1b36307f3f23271f070f1f7f3ff8f8f8b818d8d8b8e0808040e0e0e0c0010204040808101003070f1f3f7fff1f000f130d0d130c201f100c12122c3f3f002400240004000037363636161612020f41008800440000107efffff6763a1a387cfefe3b030303000038040000000003337b7ffffb03030000003840000000dcc0e0e0e0e0e0c0fca08080000000003f5f3f3fbbf8fefe0727574f5727c1211f0f0f1f1f1e38301d0f0f1f1f1e38300020606070f0f8f8000038104c188624f8fcfc7e7e3e1f0700420a401002080200c070b8f4f2f57b00008040080c0a8400df10ffdffffff90000cf202020262e1f1f3efcf8f0c000e0e0c00000000000f8fcfeffffdfdf002f23212020000000c1f1797d3d3f1f03c1b1596d353b1f0302060e0e1e1e3e3e00020008020028003e3e3e3e1e1e0e020410021004000a00c1f1797d3d3f1f03c1b1596d353b1f037c0000ffc37f1f03000f1ffffc631f03ffff7c00007cffff0000fec6c6fe0000ffff00040c183000000006060c187060ffff0004040408080000060604040808081010000010100808103030303010087f3f3f3e1f0f03000000010301000000030fff7f7f7f7f7f030ef80000000000000000000000000022652525252577720000000000000000629515254585f7f20000000000000000a2a5a5a5f5f527220000000000000000f28585e51515f7e2000000000000000062955565b59597620000000000000000205050505050702000000000000000000000000000000000001212121210087b6cec6c6c6c6ff700004c4949434ec898bcb2b2b2bcb0300000000000007c38000000000000040800', 'hex');
            fs.writeFile('./projects/' + projectDir + '/sprite.spr', defaultSprites, function(err){
                if (err){
                    handleNewProjectFileException(err, projectDir, 'sprite.spr', clientMessage);
                } else {
                    console.log("creted sprite file for project: " + projectDir);
                }
                filesRemaining -= 1;
                if (filesRemaining === 0){
                    cb(clientMessage);
                }
            });
            var defaultBackgrounds = Buffer.from('00000000000000000000000000000000ff00ff000000000000ffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff0000000000000000', 'hex');
            // var defaultBackgrounds = Buffer.from('7cfee7e7e77f3e000038212121033e00183c1c1c1c7e3f000004040404003f007cfe7f7ffcfe7f00003861071c007f007e3f3c1ec77f3e000037001801033e001c3e7eeefe7f06000002122200730600fcfefc7ec77f3e00003e007801033e007cfefcfee77f3e00003e003821033e00feff6f1e3c381800003963060c0818007cfe7ffee77f3e000038033821033e007cfee77f3f7f3e000038210139033e00387cf6e7ffffe7630010302101392163fcfee7fffee7ff7e003821033821037e3c7ef3e0e0663f1e001833202000031ef8fce6e7e7effe7c003020212123067cfeffe0fcfee0fe7f003f20003e20007ffeffe0fcfee0e060003f20003e2020603e7ff0eee7673f1f001f30202101011fc6e7e7ffffe7e76300212101392121637e1f1c1c1c1c7e3f000704040404003f1e070707c7e77f3e000101010121033ec6effefcf8fcee670023260c002020676070707070707e3f001010101010003fc6efffffffefe7630001010129292163c6e7f7ffffefe76300010101212121637cfee7e7e7e77f3e003821212121033efcfee7e7fffee06000382121033e20607cfee7e7ffef7e3d003821212123043dfcfee7effffcee67003821210720206778fce67c3ec77f3e003026003801033e7e1f1c1c1c1c1c0c000704040404040cc6e7e7e7e7e77f3e002121212121033ec6e7e7ef7f3e1c080021210103060c08c6e7f7fffffff7630021210101113163c6ef7f3e7cfef76300010306001031636677773f1c1c1c0c001111030404040cfe7f1f3e7cf8fe7f007103060c18007f00000000000000000000000000000000ffffffffffffffff00000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffff0000007e7f3f000000000000013f00000000663c183c66000000221408142200ffffffffffffffff7f7f7f7f7f7f7f7f1c3e3e3e1e1c001c0402020206040004ff7f7f7f7fffe3c1ff80808080001c3e808080c1e3ffffff7f7f7f3e1c0000ff387c7c7c7c7c3800080404040404080003060c0c0808040303050b0b0f0f070301020408102040800103070f1f3f7fff00000000000738c00000000000073fff0000000000e01c030000000000e0fcff804020100804020180c0e0f0f8fcfeff040e0e0e6e646060ffffffffffffffff070f1f1f7fffff7f070810006080804003071f3f3f3f79f70304182020204688c0e0f0f4febfdfffc02010140a41210190b8f8fafffffffe90a8480a050101023b1d0e0f070000002412090807000000ffbf1cc0f3ff7e1c0040e33f0c81621cbf7f3d83c7ffff3c4080c27c3800c33cfcfefffefef860000402010006986000c0201010101020c0c0e0f0f0f0f0e0c0000000003f7fe0c00000000000001c3e889c8880808080807f7f7f3e1c000000fefefefefefefefeffffffffffffffff081424c40340a12600081838fcbf5ed9ffffffff7f7f7f7f8181818181818181ffffffffffffffff01010101010101017f8080989c8c8080007f7f67677f7f7fff0101ff101010ff00ffffffffffffff80808080808080807f7f7f7f7f7f7f7f010101ff101010ffffffffffffffffffff0000000000000000fffffffffffffffe0101191d0d010100ffffe7e7ffffff0101010101010101ffffffffffffffff3f7f7fffffffffff3f6040c080808080ffffffffffff7e3c808080808081423cffffffffffffffffff00000000000000fffffffffffffe7c000000000001827cfffffffffffffe7c00000000000183fff8fcfefefffffffff804020201010101ffffffffffff7e3c010101010181423c0008080810101000ffffffffffffffff007f7f787373737f7f80a0878f8e8e8600ffff3f9f9f9f1ffe0105c1e17171f17e7e7f7e7e7f7fff8181808181a080ff7f7fff7f7ffffffff1c1c181c1c501ff7f80a080808080807ffffffffffffffffe01050101010101feffffffffffffff8080808080a0807fffffffffffffff7f01010101010501fefffffffffffffffe00000000fcfe0703000000000000387c1139110101010101fefefe7c38000000ef2828282828ef0020e7e7e7e7e7ef00fe8282828282fe00027e7e7e7e7efe00808080989c8c807f7f7f7f67677f7f7fffff83f3f3f3f3f3ff80fc8c8c8c8c8cfffff0f6f6f6f6f6ff000f0909090909ffff000000000000ff00ffffffffffffffff01572f572f57ff01ffa9d1a9d1a9f3f3f3f3f3f3ff3f8c8c8c8c8c8cff3ff6f6f6f6f6f6ffff090909090909ffff000000000000ffffffffffffffffffff2f572f572f57fffcd1a9d1a9d1a9fffc3c3c3c3c3c3c3c3c2323232323232323fbfbfbfbfbfbfbfb0404040404040404bc5cbc5cbc5cbc5c44a444a444a444a41f204040808080811f3f7f7ffffffffeff8080c0fffffefeff7f7f3f00000101ff7f7fffff070303ff80800000f8fcfcff0000000081c3ffffffffffff7e3c00f8fcfefee3c18181f80402021d3f7f7f83ffffffffff7f1ffc8080808080601ffcfcfcfcfefeffff03030303010100ff01010101030307fffefefefefcfcf8ffffffffffffffffff00000000000000ff81c1e3fffffffffe7f3f1d01010103fefffffffffffbb5ce808080808084cab1ffffffffffdfad73010101010121538d77777777777777770000000077ffffff00000000000000ffffffffffffffffff7777777700000000ffffff7777777777010101191d0d01feffffffe7e7fffffe20787ffefefefefe0021214141414141049afafdfdfdfdfd00808080808080807e382100010001002121010101010101fa8a8480808080808080808080808080020400100040800001010608182020c00b0b3b0bfb0b0b0a0404c4f4f404040590101f101f10109070f0f0fffff0f0703f78e7cf58585090c08718b0e7e7efefb0fce2c1c1838f7e6f435d3f3f7f7ffffe030f917060203103fff16ecfdfffff3f3f1d397bf386fefdfbfbf7f70f7fffffffffffff8080ffff80808080ffff80feffffffff0303fffe03030303ffff0300ffffffffff000000ff00000000ffff3cfcfcfcfcfc040423f30b0b0b07ffffffffffff80ffffff80808080ff808080ffffffff03ffffff03030303ff030303ffffffffff00ffff0000000000ff0000fcfcfefefe02fefe0707030303ff0303ff8080808080808080ffffffffffffffff0303030303030303ffffffffffffff0202020202020404ffffffffffffffff8080aad5aaffffffffffd5aad58080ff0303ab57abfffffeffff57ab570303fe0055aa55ffffff00ffaa55aa0000ff000454ac5cfcfcfc3cffaf57ab0b0bf3233f3f3f3f000000ffffffffffffffffff7e7c7c78000000ffffffffffffffffff1f0f0f07000000fffffffffffffffffffefcfcf8000000ffffffffffffffffff00000000ffff0000000000000000000018181818181818180000000000000000071f3fff7f7fffffffffffffffffffffe1f9fdfffefefffffffffffffffffffff0101010101010ff00e0e0e0e0e0e0e01f101010101010ff000f0f0f0f0f0f0f929292fefe00000048486c000000fe000a0a3a0afb0b0b0b0505c5f5f404040490909f909f9090907070707f7f7070700101010101010101000000000000000080808080808080800000000000000000088891d15353733ffffffffffffebece0000070f0c1b1b1b00000000030404040000e0f0f0f8f8f800006030309898981b1b1b1b1b0f0f070404040404030000f8f8f8f8f8f0f0e09898989898303060f111111f101010ff0fefefefefefefe01f1010f0101010ffe0efefefefefef0f7fbfdfeff0f0f0f0804020100f0f0f0ff0f0f0f0ffffffff0f0f0f0f1f3f7fffffffffff0f0f0f0f0103070fffffffff0f0f0f0ff7fbfdfeffffffffffffffff000000000030381800000000000008181f3f7f7f7fffffff1f20404040808282ffffff7f7f7f3f1e8280a0444340211ef8fcfefefefffffff804020202014141fffffffefefefc7841010522c20284787f80808080808080807f7f7f7f7f7f7fde616161715e7f6161dfdfdfdfffc1df8080c0f0bf8f817e7f7fff3f4f717fff6161c1c1818183fedfdfbfbf7f7f7f7f0000030f1f3f7f7f0000030c102040400000c0f0f8fcfefe0000c03008040202ffffffffffffffff8080808080808080ffffffffffffffff01010101010101017f7f7f3f3f1f0f0740404020301c0f07fefefefcfcf8f0f0020202040c38f0f00f0f0f0f0f0f070f08080808080c050af0f0f0f0f0f0e0f0105050505030a05081c1a3a39d818181004122221c000000e3f7c1c1c1c1f7e3e3143e3e3e3e14e30000070f0c1b1b1bfffff8f0f0e0e0e00000e0f0f0f8f8f8ffff7f3f3f9f9f9f1b1b1b1b1b0f0f07e0e0e0e0e0f3f0f8f8f8f8f8f8f0f0e09f9f9f9f9f3f3f7fe0ffffffffffffff00701f10707f7f7f07ffffffffffffff0003f80003fbfbfbfffffffffffeffef7c7b767575771767ffdfefafaf6fefe73bfb7bfbfbf3f8f31f1f3f3f7063e7e50f0f1f1f3f3c787af0f0f8f80cc4e4a6f8f8fcfcfe3e1e5fe9e9e9efe2e3f0ff767676707d7c7f7f969696f646c60efe6f6f6f0fbf3fffff000f030303030301fff0fdfdfdfdfdff3c4299a1a199423c00000000000000000f1f1f3f3f7f7f7ff0e0e0c0c0808080f0f8f8fcfcfefefe0f070703030101017f7f3f3f3f3f1f1f8080c0c0e0f8fefffefffffffcfcfefeff7f1f07030301817f7f7f3f3f3f3f1f808080c0c0e0e0f0fefefffffffffffe010101030307070f1f0f0f0700000000fffffffffffffffffefcfcf800000000ffffffffffffffff7e7e7e7e7f7f7f7f8181818181818181fffffffffffffffe010101030307070ffefefefeffffffff01010101010101017f7f7f7f7f7f7f7f8181818181818181fffffffffcfefe7eff030303030303ffffffffff00000000ffffffffffffffff7f7f7f7f7f7f7f7f8080808080808080fffffffffffffffe01010103070301017e7e7f7f7f7f7f7f81818181818181813f3f3f3f00000000ffffffffffffffff7e7c7c7800000000fffffffffffffffffefeffff7f7f7f7f81818181818181817f7f3f3f3f3f1f1f8080c0c0e0f8feff3fbffffffcfcfefeff7f1f07030301817f7f7e7e7f7f7f7f81818181818181817e7e7e7e7f7f7f7f818181818181818181c3c3e7e7ffffff7e3c3c18180000000f435b5331190f07f2fefeffffeff7f8c1c3c684fcfc0e02bfbebd7b7b07f3fd102022bae6e1c0c0ffffff67599ebfbf3f3f3f1f1f0f0f07c0e0e0f0f8f8fcfefffffffffefcfcf80307070f1f1f3f7f0303010000000000fffffffffffffffff0f0e0c000000000ffffffffffffffff000810222444480803070c191333276700000000000000006f6f77373b1c0f030000000000000000e0f81ceef6f7fbfb0000000000000000fbfbf7f6ee1cf8e000000000000000000000000f1f18181800000000000000001818181f0f0000000000000000000000000000ffff0000000000000000000000000000f0f8181818000000000000000018181818181818180000000000000000181818f8f000000030387830000000000008183000000000e4f6dedefef6d34900624a4a1a524049b8fcf6fefcf6fe9c005852465852c69cf7ffc6f6fec6f67a007b42027a42027a38bcf6f6f6f6fe5c001852525252465c00ffffffffffffffffffffffffffffff', 'hex');
            fs.writeFile('./projects/' + projectDir + '/background.bkg', defaultBackgrounds, function(err){
                if (err){
                    handleNewProjectFileException(err, projectDir, 'background.bkg', clientMessage);
                } else {
                    console.log("created background file for project: " + projectDir);
                }
                filesRemaining -= 1;
                if (filesRemaining === 0){
                    cb(clientMessage);
                }
            });
            var defaultSpritePalettePairs = '0123000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000';
            fs.writeFile('./projects/' + projectDir + '/spritePalettePairs.txt', defaultSpritePalettePairs, function(err){
                if (err){
                    handleNewProjectFileException(err, projectDir, 'spritePalettePairs.txt', clientMessage);
                } else {
                    console.log("created sprite palette pairs file for project: " + projectDir);
                }
                filesRemaining -= 1;
                if (filesRemaining === 0){
                    cb(clientMessage);
                }
            });
            var backgroundPalettePairs = '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000';
            fs.writeFile('./projects/' + projectDir + '/backgroundPalettePairs.txt', backgroundPalettePairs, function(err){
                if (err){
                    handleNewProjectFileException(err, projectDir, 'backgroundPalettePairs.txt', clientMessage);
                } else {
                    console.log("created background palette pairs file for project: " + projectDir);
                }
                filesRemaining -= 1;
                if (filesRemaining === 0){
                    cb(clientMessage);
                }
            });
        }
    });
}

///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////EXCEPTION HANDLERS///////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
//https://github.com/nodejs/help/issues/882
//https://nodejs.org/api/errors.html#errors_common_system_errors

function handleInitServerException(err, clientMessage){
    console.log("handleInitServerException Triggered");
    if (err.code === "EEXIST"){
        console.log("projects folder already exists - ignoring creation");
    } else if (err.code === "EACCES"){
        clientMessage.condition = false;
        clientMessage.message = "Permission denied when initializing server";
        console.log("Permission denied when initializing server");
    } else {
        clientMessage.condition = false;
        clientMessage.message = "Unexpected error encountered when initializing server";
        throw err;
    }
    console.log("\n");
}

function handleNewProjectDirectoryException(err, projectDir, dir, clientMessage){
    console.log("handleNewProjectDirectoryException Triggered");
    if (err.code === "EEXIST"){
        console.log("Given project name: " + projectDir + " already exists so new project could not be saved");
        clientMessage.condition = false;
        clientMessage.message = "Given project name already exists. New project could not created";
    } else {
        clientMessage.condition = false;
        clientMessage.message = "Unexpected error encountered when creating new project directory";
        throw err;
    }
    console.log("\n");
}

function handleNewProjectFileException(err, projectDir, file, clientMessage){
    console.log("handleNewProjectFileException Triggered");
    if (err.code === "EEXIST"){
        console.log("Given file name: " + file + " already exists for project: " + projectDir + " so new project could not created");
        clientMessage.condition = false;
        clientMessage.message = "Given file name: " + file + " already exists for project: " + projectDir + " so new project could not created";
    } else{
        clientMessage.condition = false;
        clientMessage.message = "Unexpected error encountered when creating files for new project";
        throw err;
    }
    console.log("\n");
}

function handleOpenProjectException(err, projectDir, file, clientMessage){
    console.log("handleOpenProjectException Triggered");
    if (err.code === "ENOENT"){
        console.log("could not read file: " + file + " in project: " + projectDir);
        clientMessage.condition = false;
        clientMessage.message = "Could not read file: " + file;
    } else {
        clientMessage.condition = false;
        clientMessage.message = "Unexpected error encountered when opening project";
        throw err;
    }
    console.log("\n");
}

function handleSaveProjectException(err, projectDir, clientMessage){
    console.log("handleSaveProjectException Triggered");
    console.log("could not save project: " + projectDir);
    console.log("\n");
    clientMessage.condition = false;
    clientMessage.message = "Unexpected error encountered when saving project";
    throw err;
}

///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////HELPER FUNCTIONS////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
async function transcribePalServerToClient(cb){
    fs.readFile('./projects/' + checkedOutProjectName + '/palette.pal', {encoding: 'hex'}, function(err, data){
        var palArray = data.match(/.{1,2}/g);
        var pal = {background: [], sprite: []};
        var backgroundPalArray = [];
        var spritePalArray = [];
        var indicesToUse = [0,1,2,3,5,6,7,9,10,11,13,14,15];
        for (var i = 0; i < 2; i++){
            for (var j = 0; j < palArray.length / 2; j++){
                if (i === 0){
                    if (indicesToUse.indexOf(j) > -1){
                        backgroundPalArray.push("0x" + palArray[j]);
                    }
                }
                else if (i === 1){
                    if (indicesToUse.indexOf(j) > -1){
                        spritePalArray.push("0x" + palArray[j + (palArray.length / 2)]);
                    }
                }
            }
        }
        pal.background = backgroundPalArray;
        pal.sprite = spritePalArray;

        cb(pal);
    });
}

function transcribePalClientToServer(cb){
    var backgroundPaletteCopy = savedata.backgroundPalette.slice();
    var spritePaletteCopy = savedata.spritePalette.slice();

    //remove first element - universal color and store it
    var universalColor = backgroundPaletteCopy.shift().substr(2, 2);
    spritePaletteCopy.shift();

    var cleanedBackgroundPalette = [];
    var cleanedSpritePalette = [];

    //go through both the backgroundPalette and spritePalette client data and take away the 0x prefix
    for (var i = 0; i < backgroundPaletteCopy.length; i++){
        var strippedBackgroundColor = backgroundPaletteCopy[i].substr(2, 2);
        var strippedSpriteColor = spritePaletteCopy[i].substr(2, 2);

        if (i % 3 === 0){
            cleanedBackgroundPalette.push(universalColor);
            cleanedSpritePalette.push(universalColor);    
        }

        cleanedBackgroundPalette.push(strippedBackgroundColor);
        cleanedSpritePalette.push(strippedSpriteColor);
    }

    //get a string version of the array data to use a hex buffer to write to the files
    var paletteData = Buffer.from(cleanedBackgroundPalette.join('') + cleanedSpritePalette.join(''), 'hex');

    fs.writeFile('./projects/' + checkedOutProjectName + '/palette.pal', paletteData, function(err){
        cb("retval");
    });
}

function transcribeSprServerToClient(cb){
    fs.readFile('./projects/' + checkedOutProjectName + '/sprite.spr', {encoding: 'hex'}, function(err, data){
        var spriteArray = data.match(/.{1,32}/g);
        var sprites = [];
        
        //create 256 sub arrays for the sprite tiles
        for (var i = 0; i < 256; i++){
            sprites.push(new Array());
        }

        for (var i = 0; i < spriteArray.length; i++){
            for (var j = 0; j < spriteArray[i].length / 2; j += 2){
                //set 1st half with 2nd half respective data
                var leftHalf = spriteArray[i].substring(j, j + 2);
                var rightHalf = spriteArray[i].substring(j + 16, j + 16 + 2);

                //convert hex strings to binary
                var leftHalfBinary = ("00000000" + (parseInt(leftHalf, 16)).toString(2)).substr(-8);
                var rightHalfBinary = ("00000000" + (parseInt(rightHalf, 16)).toString(2)).substr(-8);

                //compare binary bits and generate color numbers
                for (var k = 0; k < leftHalfBinary.length; k++){
                    if (leftHalfBinary[k] === '0' && rightHalfBinary[k] === '0'){
                        // sprites.push(0);
                        sprites[i % 256].push('0');
                    }
                    else if (leftHalfBinary[k] === '1' && rightHalfBinary[k] === '0'){
                        // console.log("1: " + leftHalfBinary + " " + rightHalfBinary);
                        // sprites.push(1);
                        sprites[i % 256].push('1');
                    }
                    else if (leftHalfBinary[k] === '0' && rightHalfBinary[k] === '1'){
                        // console.log("2: " + leftHalfBinary + " " + rightHalfBinary);
                        // sprites.push(2);
                        sprites[i % 256].push('2');
                    }
                    else if (leftHalfBinary[k] === '1' && rightHalfBinary[k] === '1'){
                        // console.log("3: " + leftHalfBinary + " " + rightHalfBinary);
                        // sprites.push(3);
                        sprites[i % 256].push('3');
                    }
                }
            }
        }
        cb({sprites: sprites});
    });
}

function transcribeSprClientToServer(cb){
    var spritesCopy = savedata.sprites;

    var hexData = new Array(4096);
    var hexDataCounter = 0;
    var rowCounter = 0;
    for (var i = 0; i < spritesCopy.length; i++){ //read each tile once
        for (var j = 0; j < spritesCopy[i].length; j+=8){ //skip over an entire row each time
            //get 8 cell indices
            var cellCluster = [];
            for (var k = 0; k < 8; k++){ //read the row into the cell cluster
                // hexDataCounter += 1;
                cellCluster.push(spritesCopy[i][j + k]);
            }

            var leftHalfBinary = [];
            var rightHalfBinary = [];
            for (var k = 0; k < cellCluster.length; k++){
                if (cellCluster[k] === '0'){
                    leftHalfBinary.push('0');
                    rightHalfBinary.push('0');
                }
                else if (cellCluster[k] === '1'){
                    leftHalfBinary.push('1');
                    rightHalfBinary.push('0');
                }
                else if (cellCluster[k] === '2'){
                    leftHalfBinary.push('0');
                    rightHalfBinary.push('1');
                }
                else if (cellCluster[k] === '3'){
                    leftHalfBinary.push('1');
                    rightHalfBinary.push('1');
                }
            }

            //obtain string versions of the binary arrays
            leftHalfBinary = leftHalfBinary.join('');
            rightHalfBinary = rightHalfBinary.join('');

            //obtain an integer value from the binary
            leftHalfDec = parseInt(leftHalfBinary, 2);
            rightHalfDec = parseInt(rightHalfBinary, 2);

            //obtain string hex values from the integer values
            leftHalfHex = leftHalfDec.toString(16);
            rightHalfHex = rightHalfDec.toString(16);

            //pad the hex values if there is only one digit
            if (leftHalfHex.length < 2){
                leftHalfHex = '0' + leftHalfHex;
            }
            if (rightHalfHex.length < 2){
                rightHalfHex = '0' + rightHalfHex;
            }

            hexData[hexDataCounter] = leftHalfHex;
            hexData[hexDataCounter + 8] = rightHalfHex;

            if (rowCounter === 7){
                hexDataCounter += 9;
                rowCounter = 0;
            }
            else{
                hexDataCounter += 1;
                rowCounter += 1;
            }
        }
    }

    hexData = hexData.join('');
    var dataToWrite = Buffer.from(hexData, 'hex');

    fs.writeFile('./projects/' + checkedOutProjectName + '/sprite.spr', dataToWrite, function(err){
        cb("retval");
    });
}

function transcribeBkgServerToClient(cb){
    fs.readFile('./projects/' + checkedOutProjectName + '/background.bkg', {encoding: 'hex'}, function(err, data){
        var backgroundArray = data.match(/.{1,32}/g);
        var backgrounds = [];
        
        //create 256 sub arrays for the sprite tiles
        for (var i = 0; i < 256; i++){
            backgrounds.push(new Array());
        }

        for (var i = 0; i < backgroundArray.length; i++){
            for (var j = 0; j < backgroundArray[i].length / 2; j += 2){
                //set 1st half with 2nd half respective data
                var leftHalf = backgroundArray[i].substring(j, j + 2);
                var rightHalf = backgroundArray[i].substring(j + 16, j + 16 + 2);

                //convert hex strings to binary
                var leftHalfBinary = ("00000000" + (parseInt(leftHalf, 16)).toString(2)).substr(-8);
                var rightHalfBinary = ("00000000" + (parseInt(rightHalf, 16)).toString(2)).substr(-8);

                //compare binary bits and generate color numbers
                for (var k = 0; k < leftHalfBinary.length; k++){
                    if (leftHalfBinary[k] === '0' && rightHalfBinary[k] === '0'){
                        backgrounds[i % 256].push('0');
                    }
                    else if (leftHalfBinary[k] === '1' && rightHalfBinary[k] === '0'){
                        backgrounds[i % 256].push('1');
                    }
                    else if (leftHalfBinary[k] === '0' && rightHalfBinary[k] === '1'){
                        backgrounds[i % 256].push('2');
                    }
                    else if (leftHalfBinary[k] === '1' && rightHalfBinary[k] === '1'){
                        backgrounds[i % 256].push('3');
                    }
                }
            }
        }
        cb({backgrounds: backgrounds});
    });
}

function transcribeBkgClientToServer(cb){
    var backgroundsCopy = savedata.backgrounds;

    var hexData = new Array(4096);
    var hexDataCounter = 0;
    var rowCounter = 0;
    for (var i = 0; i < backgroundsCopy.length; i++){ //read each tile once
        for (var j = 0; j < backgroundsCopy[i].length; j+=8){ //skip over an entire row each time
            //get 8 cell indices
            var cellCluster = [];
            for (var k = 0; k < 8; k++){ //read the row into the cell cluster
                // hexDataCounter += 1;
                cellCluster.push(backgroundsCopy[i][j + k]);
            }

            var leftHalfBinary = [];
            var rightHalfBinary = [];
            for (var k = 0; k < cellCluster.length; k++){
                if (cellCluster[k] === '0'){
                    leftHalfBinary.push('0');
                    rightHalfBinary.push('0');
                }
                else if (cellCluster[k] === '1'){
                    leftHalfBinary.push('1');
                    rightHalfBinary.push('0');
                }
                else if (cellCluster[k] === '2'){
                    leftHalfBinary.push('0');
                    rightHalfBinary.push('1');
                }
                else if (cellCluster[k] === '3'){
                    leftHalfBinary.push('1');
                    rightHalfBinary.push('1');
                }
            }

            //obtain string versions of the binary arrays
            leftHalfBinary = leftHalfBinary.join('');
            rightHalfBinary = rightHalfBinary.join('');

            //obtain an integer value from the binary
            leftHalfDec = parseInt(leftHalfBinary, 2);
            rightHalfDec = parseInt(rightHalfBinary, 2);

            //obtain string hex values from the integer values
            leftHalfHex = leftHalfDec.toString(16);
            rightHalfHex = rightHalfDec.toString(16);

            //pad the hex values if there is only one digit
            if (leftHalfHex.length < 2){
                leftHalfHex = '0' + leftHalfHex;
            }
            if (rightHalfHex.length < 2){
                rightHalfHex = '0' + rightHalfHex;
            }

            hexData[hexDataCounter] = leftHalfHex;
            hexData[hexDataCounter + 8] = rightHalfHex;

            if (rowCounter === 7){
                hexDataCounter += 9;
                rowCounter = 0;
            }
            else{
                hexDataCounter += 1;
                rowCounter += 1;
            }
        }
    }

    hexData = hexData.join('');
    var dataToWrite = Buffer.from(hexData, 'hex');

    fs.writeFile('./projects/' + checkedOutProjectName + '/background.bkg', dataToWrite, function(err){
        cb("retval");
    });
}

function transcribeTxtServerToClient(cb){
    fs.readFile('./projects/' + checkedOutProjectName + '/code.s', {encoding: 'utf8'}, function(err, data){
        var code = {code: data};
        cb(code);
    });
}

function transcribeTxtClientToServer(cb){
    fs.writeFile('./projects/' + checkedOutProjectName + '/code.s', savedata.code, function(err){
        cb("retval");
    });
}

function transcribeSprPalPairsServerToClient(cb){
    fs.readFile('./projects/' + checkedOutProjectName + '/spritePalettePairs.txt', {encoding: 'utf8'}, function(err, data){
        var pairs = {sprPalPairs: data};
        cb(pairs);
    });
}

function transcribeSprPalPairsClientToServer(cb){
    fs.writeFile('./projects/' + checkedOutProjectName + '/spritePalettePairs.txt', savedata.sprPalPairs, function(err){
        cb("retval");
    });
}

function transcribeBkgPalPairsServerToClient(cb){
    fs.readFile('./projects/' + checkedOutProjectName + '/backgroundPalettePairs.txt', {encoding: 'utf8'}, function(err, data){
        var pairs = {bkgPalPairs: data};
        cb(pairs);
    });
}

function transcribeBkgPalPairsClientToServer(cb){
    fs.writeFile('./projects/' + checkedOutProjectName + '/backgroundPalettePairs.txt', savedata.bkgPalPairs, function(err){
        cb("retval");
    });
}